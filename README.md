# tech-seminar-zero-downtime-deployment

[docker, git action CI/CD ÌôòÍ≤ΩÏóêÏÑú nginxÎ•º ÌÜµÌïú blue/green Î¨¥Ï§ëÎã® Î∞∞Ìè¨ Ï†ÅÏö©ÌïòÍ∏∞ (1)](https://velog.io/@rlaxoqkf14/docker-git-action-CICD-%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C-nginx%EB%A5%BC-%ED%86%B5%ED%95%9C-bluegreen-%EB%AC%B4%EC%A4%91%EB%8B%A8-%EB%B0%B0%ED%8F%AC-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0-1)
<br/>
[docker, git action CI/CD ÌôòÍ≤ΩÏóêÏÑú nginxÎ•º ÌÜµÌïú blue/green Î¨¥Ï§ëÎã® Î∞∞Ìè¨ Ï†ÅÏö©ÌïòÍ∏∞ (2)](https://velog.io/@rlaxoqkf14/docker-git-action-CICD-%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C-nginx%EB%A5%BC-%ED%86%B5%ED%95%9C-bluegreen-%EB%AC%B4%EC%A4%91%EB%8B%A8-%EB%B0%B0%ED%8F%AC-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0-2)

------------------
- ÎèôÏûë Í≥ºÏ†ï
    1. Spring boot AppÏóêÏÑú 80ÏúºÎ°ú ÏöîÏ≤≠ Ï†ÑÏÜ°
    2. nginxÍ∞Ä ec2ÏóêÏÑú ÌòÑÏû¨ Ïã§ÌñâÏ§ëÏù∏ container ÌôïÏù∏
    3. blueÍ∞Ä Ïã§ÌñâÏ§ëÏù¥Î©¥ green / greenÏù¥ Ïã§ÌñâÏ§ëÏù¥Î©¥ blue Ïù¥ÎØ∏ÏßÄÎ•º 
    docker-composeÎ•º ÌÜµÌï¥ pull
    4. Î∂àÎü¨Ïò® Ïù¥ÎØ∏ÏßÄÍ∞Ä ÎπåÎìúÍ∞Ä Ï†úÎåÄÎ°ú ÎêêÎäîÏßÄ Î¨¥ÌïúÎ£®ÌîÑÎ•º ÎèåÎ©¥ÏÑú ÌôïÏù∏
    5. ÎπåÎìúÍ∞Ä ÏÑ±Í≥µÌïòÎ©¥ nginxÎ•º Ïû¨Ïã§Ìñâ ÌõÑ Ïù¥ÎØ∏ÏßÄÏóê Ìï¥ÎãπÌïòÎäî configÎ°ú Ïó∞Í≤∞
    (Í∏∞Î≥∏Ï†ÅÏúºÎ°ú nginx configÎäî defaultÎ•º Î∞îÎùºÎ≥¥Í≥† ÏûàÏùå ‚Üí Ïù¥ defaultÍ∞Ä Ìï¥ÎãπÌïòÎäî Ïù¥ÎØ∏ÏßÄ configÎ°ú Î∞îÎùºÎ≥¥Í≤å ÏÑ§Ï†ï)
    6. Ïù¥Ï†ÑÏóê Ïã§ÌñâÏ§ëÏù¥ÏòÄÎçò Ïª®ÌÖåÏù¥ÎÑàÎ•º Îã§Ïö¥
 
- docker-compose.yml
  ```shell
  version: '3'
  services:
    blue:
      image: rlaxoqkf/majorfolio:latest
      container_name: blue
      restart: always
      ports:
        - 8081:8080
    green:
      image: rlaxoqkf/majorfolio:latest
      container_name: green
      restart: always
      ports:
        - 8082:8080
  ```

  - deploy.sh
  ```shell
      #!/bin/bash
    
    IS_GREEN_EXIST=$(docker ps | grep green)
    DEFAULT_CONF=" /etc/nginx/nginx.conf"
    
    # blueÍ∞Ä Ïã§Ìñâ Ï§ëÏù¥Î©¥ greenÏùÑ upÌï©ÎãàÎã§.
    if [ -z $IS_GREEN_EXIST ];then
      echo "### BLUE => GREEN ####"
      echo ">>> green imageÎ•º pullÌï©ÎãàÎã§."
      docker-compose pull green
      echo ">>> green containerÎ•º upÌï©ÎãàÎã§."
      docker-compose up -d green
      while [ 1 = 1 ]; do
      echo ">>> green health check Ï§ë..."
      sleep 3
      REQUEST=$(curl http://127.0.0.1:8082)
        if [ -n "$REQUEST" ]; then
          echo ">>> üçÉ health check success !"
          break;
        fi
      done;
      sleep 3
      echo ">>> nginxÎ•º Îã§Ïãú Ïã§Ìñâ Ìï©ÎãàÎã§."
      sudo ln -s -f /etc/nginx/sites-available/green /etc/nginx/sites-enabled/default
      sudo nginx -s reload
      echo ">>> blue containerÎ•º downÌï©ÎãàÎã§."
      docker-compose stop blue
    
    # greenÏù¥ Ïã§Ìñâ Ï§ëÏù¥Î©¥ blueÎ•º upÌï©ÎãàÎã§.
    else
      echo "### GREEN => BLUE ###"
      echo ">>> blue imageÎ•º pullÌï©ÎãàÎã§."
      docker-compose pull blue
      echo ">>> blue container upÌï©ÔøΩÔøΩÎã§."
      docker-compose up -d blue
      while [ 1 = 1 ]; do
        echo ">>> blue health check Ï§ë..."
        sleep 3
        REQUEST=$(curl http://127.0.0.1:8081)
        if [ -n "$REQUEST" ]; then
          echo ">>> üçÉ health check success !"
          break;
        fi
      done;
      sleep 3
      echo ">>> nginxÎ•º Îã§Ïãú Ïã§Ìñâ Ìï©ÎãàÎã§."
      sudo ln -s -f /etc/nginx/sites-available/blue /etc/nginx/sites-enabled/default
      sudo nginx -s reload
      echo ">>> green containerÎ•º downÌï©ÎãàÎã§."
      docker-compose stop green
    fi
  ```

  - /etc/nginx/site-availibles/blue
  ```shell
    server {
  
          listen 80 default_server;
  
          listen [::]:80 default_server;
  
  
  
          # SSL configuration
  
          #
  
          # listen 443 ssl default_server;
  
          # listen [::]:443 ssl default_server;
  
          #
  
          # Note: You should disable gzip for SSL traffic.
  
          # See: https://bugs.debian.org/773332
  
          #
  
          # Read up on ssl_ciphers to ensure a secure configuration.
  
          # See: https://bugs.debian.org/765782
  
          #
  
          # Self signed certs generated by the ssl-cert package
  
          # Don't use them in a production server!
  
          #
  
          # include snippets/snakeoil.conf;
  
  
  
          root /var/www/html;
  
  
  
          # Add index.php to the list if you are using PHP
  
          index index.html index.htm index.nginx-debian.html;
  
  
  
          server_name localhost;
  
  
  
          location / {
  
                  proxy_pass http://localhost:8081;
  
                  proxy_set_header X-Real-IP $remote_addr;
  
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  
                  proxy_set_header Host $http_host;
  
          }
  
  
  
          # pass PHP scripts to FastCGI server
  
          #
  
          location ~ \.php$ {
  
                  include snippets/fastcgi-php.conf;
  
          #
  
          #       # With php-fpm (or other unix sockets):
  
                  fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
  
          #       # With php-cgi (or other tcp sockets):
  
          #       fastcgi_pass 127.0.0.1:9000;
  
          }
  
  
  
          # deny access to .htaccess files, if Apache's document root
  
          # concurs with nginx's one
  
          #
  
          #location ~ /\.ht {
  
          #       deny all;
  
          #}
  
    }
  ```

    - /etc/nginx/site-availibles/green
  ```shell
    server {
  
          listen 80 default_server;
  
          listen [::]:80 default_server;
  
  
  
          # SSL configuration
  
          #
  
          # listen 443 ssl default_server;
  
          # listen [::]:443 ssl default_server;
  
          #
  
          # Note: You should disable gzip for SSL traffic.
  
          # See: https://bugs.debian.org/773332
  
          #
  
          # Read up on ssl_ciphers to ensure a secure configuration.
  
          # See: https://bugs.debian.org/765782
  
          #
  
          # Self signed certs generated by the ssl-cert package
  
          # Don't use them in a production server!
  
          #
  
          # include snippets/snakeoil.conf;
  
  
  
          root /var/www/html;
  
  
  
          # Add index.php to the list if you are using PHP
  
          index index.html index.htm index.nginx-debian.html;
  
  
  
          server_name localhost;
  
  
  
          location / {
  
                  proxy_pass http://localhost:8082;
  
                  proxy_set_header X-Real-IP $remote_addr;
  
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  
                  proxy_set_header Host $http_host;
  
          }
  
  
  
          # pass PHP scripts to FastCGI server
  
          #
  
          location ~ \.php$ {
  
                  include snippets/fastcgi-php.conf;
  
          #
  
          #       # With php-fpm (or other unix sockets):
  
                  fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
  
          #       # With php-cgi (or other tcp sockets):
  
          #       fastcgi_pass 127.0.0.1:9000;
  
          }
  
  
  
          # deny access to .htaccess files, if Apache's document root
  
          # concurs with nginx's one
  
          #
  
          #location ~ /\.ht {
  
          #       deny all;
  
          #}
  
    }
  ```
